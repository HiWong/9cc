# Makefile for 7cc

# version
MAJOR = 0
MINOR = 4
FIXES = 0
EXTRAVERSION = -dev

CFLAGS = -Wall -std=c99 -I.
LDFLAGS =
7CC = 7cc
CC1 = cc1
libutils_dir = libutils/
libcpp_dir = libcpp/
burg_dir = 7burg/
target_dir = amd64/
BURG = $(burg_dir)7burg
LIBCPP = $(libcpp_dir)libcpp.a
LIBUTILS = $(libutils_dir)libutils.a
CC1_OBJ =
CC1_INC =
CONFIG_FLAGS =
KERNEL := $(shell uname)
RM = @rm -f
CONFIG_H = config.h
BUILD_DIR = "$(shell pwd)"

CC1_OBJ += error.o
CC1_OBJ += ast.o
CC1_OBJ += cc.o
CC1_OBJ += symtab.o
CC1_OBJ += type.o
CC1_OBJ += parser.o
CC1_OBJ += sema.o
CC1_OBJ += tree.o
CC1_OBJ += eval.o
CC1_OBJ += print.o
CC1_OBJ += gen.o

CC1_INC += gen.h
CC1_INC += cc.h

TARGET_OBJ = $(target_dir)x86_64-linux.o

7CC_OBJ = 7cc.o

ifneq (, ${STAGE})
CONFIG_FLAGS += -DSTAGE=${STAGE}
else
CFLAGS += -g
# CFLAGS += -pg
# LDFLAGS += -pg
endif

ifeq (Linux, $(KERNEL))

else ifeq (Darwin, $(KERNEL))
XCODE_SDK_DIR := $(shell xcrun --show-sdk-path)
OSX_SDK_VERSION := $(shell xcrun --show-sdk-version)
else
$(error unsupported platform '$(KERNEL)')
endif

CFLAGS += $(CONFIG_FLAGS)

all:: $(CONFIG_H) $(7CC) $(CC1)

$(7CC): $(LIBUTILS) $(7CC_OBJ)
	$(CC) $(7CC_OBJ) $(LIBUTILS) $(LDFLAGS) -o $@

$(CC1): $(LIBUTILS) $(LIBCPP) $(CC1_OBJ) $(TARGET_OBJ)
	$(CC) $(CC1_OBJ) $(TARGET_OBJ) $(LIBCPP) $(LIBUTILS) $(LDFLAGS) -o $@

$(CC1_OBJ): $(CC1_INC) $(CONFIG_H)

$(TARGET_OBJ): $(CC1_INC) $(CONFIG_H) $(BURG)
	cd $(target_dir) && make BURG=../$(BURG)

$(BURG):
	cd $(burg_dir) && make

$(LIBUTILS):
	cd $(libutils_dir) && make

$(LIBCPP):
	cd $(libcpp_dir) && make

$(CONFIG_H):
	@echo "/* Auto-generated by makefile. */" > $@
	@echo "#ifndef CONFIG_H" >> $@
	@echo "#define CONFIG_H" >> $@
	@echo >> $@
	@echo "#define VERSION \"$(MAJOR).$(MINOR).$(FIXES)$(EXTRAVERSION)\"" >> $@
	@echo "#define BUILD_DIR \"$(BUILD_DIR)\"" >> $@
ifeq (Linux, $(KERNEL))
	@echo "#define CONFIG_LINUX" >> $@
	@echo "#define CONFIG_COLOR_TERM" >> $@
else ifeq (Darwin, $(KERNEL))
	@echo "#define CONFIG_DARWIN" >> $@
	@echo "#define CONFIG_COLOR_TERM" >> $@
	@echo "#define XCODE_DIR \"$(XCODE_SDK_DIR)\"" >> $@
	@echo "#define OSX_SDK_VERSION \"$(OSX_SDK_VERSION)\"" >> $@
endif
	@echo >> $@
	@echo "#endif" >> $@

#
# Bootstrap
#
stage1:
	$(MAKE) objclean
	$(MAKE) CC=cc STAGE=1
	mv 7cc stage1
	mv cc1 cc1_stage1
	ln -s cc1_stage1 cc1

stage2: stage1
	$(MAKE) objclean
	$(MAKE) CC=./stage1 STAGE=2
	mv 7cc stage2
	mv cc1 cc1_stage2
	ln -s cc1_stage2 cc1

stage3: stage2
	$(MAKE) objclean
	$(MAKE) CC=./stage2 STAGE=3
	mv 7cc stage3
	mv cc1 cc1_stage3
	ln -s cc1_stage3 cc1

bootstrap: stage3
	cmp stage2 stage3
	cmp cc1_stage2 cc1_stage3

objclean::
	$(RM) *.o
	@cd $(burg_dir) && make clean
	@cd $(libutils_dir) && make clean
	@cd $(libcpp_dir) && make clean
	@cd $(target_dir) && make clean

clean:: objclean
	$(RM) $(7CC) $(CC1)
	$(RM) stage1 stage2 stage3 cc1_stage1 cc1_stage2 cc1_stage3
	$(RM) $(CONFIG_H)

